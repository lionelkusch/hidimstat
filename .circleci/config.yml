---
version: 2.1

parameters:
    # Parameters required to trigger the execution of the "host_docs" job
    GITHUB_RUN_URL:
        type: string
        default: none

workflows:
    version: 2
    build-doc-and-deploy:
        # default build and deployment of the documentation
        jobs:
            - build_doc
            - deploy:
                requires:
                - build_doc

    host_and_deploy_doc:
        # action trigger by updating the link og github
        when:
            not:
                equal: [none, << pipeline.parameters.GITHUB_RUN_URL >>]
        # The jobs should run only when triggered by the workflow
        jobs:
            - host_docs

jobs:
    # download some data from github
    host_docs:
        machine:
            image: ubuntu-2204:current
        environment:
            GITHUB_ARTIFACT_URL: << pipeline.parameters.GITHUB_RUN_URL >>
        steps:
        -   checkout
        -   run: 
                name: "unzip artifact"
                command: |
                    set -x -e
                    wget $GITHUB_ARTIFACT_URL
                    unzip DocHTML.zip -d DocHTML
        -   store_artifacts:
                path: DocHTML/
                destination: html

    # create the documentation on circleci and push it to github
    build_doc:
        docker:
            - image: cimg/python:3.13
        steps:
            - checkout
            - run: 
                name: "checkout to the good commit"
                command: ./build_tools/circle/checkout_merge_commit.sh
            - restore_cache:
                key: saved-cache
            - run:
                name: "build documentation"
                command: ./build_tools/circle/build_doc.sh
                no_output_timeout: 40m
            - store_artifacts:
                path: doc_conf/_build/html
                destination: doc_conf
            - store_artifacts:
                path: ~/log.txt
                destination: log.txt
            # Persists generated documentation so that it can be attached and deployed
            # in the 'deploy' step.
            - persist_to_workspace:
                root: doc_conf/_build/html
                paths: .
            - save_cache:
                # cache some library
                key: saved-cache
                paths:
                    - /home/circleci/nilearn_data
                    - /home/circleci/sklearn_data
    
    # deploy docmuentation on github
    # require to add a ssh key in circleci
    deploy:
        docker:
            - image: cimg/deploy:2025.01
        environment:
            ORGANIZATION: lionelkusch
            DOC_REPO: lionelkusch.github.io
            EMAIL: actions@github.com
            USERNAME: GitHub actions
        steps:
            - checkout
            - add_ssh_keys:
                fingerprints:
                    - "SHA256:SSOrd4ijaSJjqXxqBZTZ1d6oxXtMr+TpE1CWZSfqh7k"
            - run: 
                command: ./build_tools/circle/checkout_merge_commit.sh
            # Attach documentation generated in the 'build_doc' step so that it can be
            # deployed.
            - attach_workspace:
                at: doc_conf/_build/html
            - run: 
                command: |
                    mkdir -p ~/.ssh
                    ssh-keyscan github.com >> ~/.ssh/known_hosts
                    ls -ltrh doc_conf/_build/html
            - deploy:
                command: |
                    #if [[ "${CIRCLE_BRANCH}" =~ ^main$|^[0-9]+\.[0-9]+\.X$ ]]; then
                    bash build_tools/circle/push_doc.sh doc_conf/_build/html
                    #fi

